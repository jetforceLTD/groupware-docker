#!/bin/bash

. ./groupware.env-template
slist="syslog traefik imap sogo"
list="imap sogo"

dcompose() { docker-compose -f ./docker-compose.yml-template $* ; }
_down()    { for i in `echo "$slist"|tr ' ' '\n'|tac|tr '\n' ' ' | sort -r`; do ( cd $i ; dcompose down ) ; done }
_help()    { echo " usage: `basename $0` build|install|down|up|uninstall" ; exit 0 ; }

#######################################################################
if [ "$1" = "" ] ; then _help ; exit 0 ; fi
#######################################################################
if [ "$1" = "down" ] ; then _down ; exit 0 ; fi
#######################################################################
if [ "$1" = "uninstall" ] ; then
  _down
  for i in $slist ; do
    echo "remove $GLOBAL_DIR_SERV/$i"
    sudo rm -Rf $GLOBAL_DIR_SERV/$i
  done
  sudo echo "remove $GLOBAL_DIR_LOGS $GLOBAL_DIR_MAIL"
  sudo rm -Rf $GLOBAL_DIR_LOGS $GLOBAL_DIR_MAIL
  sudo rmdir $GLOBAL_DIR_SERV 2>/dev/null
  echo "cleanup /etc/hosts"
  sudo sed -i '/127.0.0.1 pfa.local*$/d'  /etc/hosts
  sudo sed -i '/127.0.0.1 sogo.local*$/d' /etc/hosts
  if [ -e ./groupware.env ] ; then
    for i in $slist ; do ( cd $i && ln -sf ../groupware.env .env ) ; done
  else
    for i in $slist ; do rm -f $i/.env ; done 
  fi
  exit 0
fi
#######################################################################
if [ "$1" = "build" ] ; then
  ( cd sogo ; dcompose build )
  ( cd imap ; dcompose build )
  exit 0
fi
#######################################################################
if [ "$1" = "install" ] ; then
  sudo mkdir -p $GLOBAL_DIR_LOGS $GLOBAL_DIR_SERV $GLOBAL_DIR_MAIL
  for i in $list ; do
    sudo mkdir -p $GLOBAL_DIR_SERV/$i/service
    if [ ! -d ./$i ] ; then
      git clone https://github.com/unimock/${i}-docker.git ${i}
    fi
    ( cd $i && ln -sf ../groupware.env-template .env )
    ( cd $i ; dcompose build )
  done
  for i in $slist ; do
    ( cd $i && ln -sf ../groupware.env-template .env )
    cp ./groupware.env-template $i/.env-template
    if [ "$i" = "sogo" ] ; then
      sudo cp -v groupware.env-template $GLOBAL_DIR_SERV/$i/service/sogo.env
    fi
  done
  if ! grep -q "127.0.0.1 pfa.local"  /etc/hosts ; then sudo sh -c "echo '127.0.0.1 pfa.local'  >> /etc/hosts" ; fi
  if ! grep -q "127.0.0.1 sogo.local" /etc/hosts ; then sudo sh -c "echo '127.0.0.1 sogo.local' >> /etc/hosts" ; fi
  ( cd ./syslog  && dcompose up -d )
  ( cd ./traefik && dcompose up -d )
  ( cd ./imap    && dcompose up -d )
  echo ""
  echo -n " the pfadmin database structure will be created "
  while  ! wget -q -O - http://pfa.local/setup.php | grep "Change setup password" >/dev/null ; do echo -n "." ; sleep 1 ; done
  PW="xxxx30"
  docker exec -it postfixadmin php -q /postfixadmin/scripts/postfixadmin-cli.php admin   add admin@domain.local --password $PW --password2 $PW --superadmin 1 --active 1
  docker exec -it postfixadmin php -q /postfixadmin/scripts/postfixadmin-cli.php domain  add       domain.local  --active 1 --default-aliases 0
  docker exec -it postfixadmin php -q /postfixadmin/scripts/postfixadmin-cli.php mailbox add  hugo@domain.local --password $PW --password2 $PW --name hugo@domain.local --active 1 --welcome-mail 0
  # xxxxx30
  #hash="601d6f6ca3333269247c9c894a3de3f7:880e680ad05db3ce51e360a691498a6343a4c59b"
  #echo "$hash" | docker exec -i postfixadmin setup
  ( cd ./sogo    ; dcompose up -d )
  echo ""
  echo " # the sogo database structure will be created ..."
  TI=30;SEC=$TI;for i in `seq $SEC -1 1`;do printf "\r %`expr length $SEC`d/$TI" "$i";sleep 1;done;echo
  ( cd sogo && dcompose restart )
  exit 0
fi
#######################################################################
if [ "$1" = "up" ] ; then
  _down >/dev/null 2>&1
  for i in $slist ; do ( cd ./$i ; dcompose up -d ) ; done
  echo ""
  echo "  login at http://${SOGO_FRONTEND_URL}/SOGo"
  echo ""
  exit 0
fi
#######################################################################

